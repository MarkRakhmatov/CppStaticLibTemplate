name: ci
on:
  pull_request:
  release:
    types: [published]
  push:
    tags:
    branches:
      - main
      - develop

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  PROJECT_NAME: CppStaticLib

  CLANG_COMPILER: "clang++"
  CLANG_TIDY_VERSION: "19.1.1"

jobs:
  build:
    permissions:
      # permission required to create branch with coverage
      contents: write
      # permission required to leave coverage comment
      pull-requests: write

    name: ${{matrix.os}} ${{matrix.cpp_compiler}} ${{matrix.build_type}} ${{matrix.generator}} ${{matrix.package_generator}}
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all matrix combinations. Consider changing this to true when your workflow is stable.
      fail-fast: false

      # Set up a matrix to run the following 3 configurations:
      # 1. <Windows, Release, latest MSVC compiler toolchain on the default runner image, default generator>
      # 2. <Linux, Release, latest GCC compiler toolchain on the default runner image, default generator>
      # 3. <Linux, Release, latest Clang compiler toolchain on the default runner image, default generator>
      #
      # To add more build types (Release, Debug, RelWithDebInfo, etc.) customize the build_type list.
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
        build_type:
          - Release
          - Debug
        cpp_compiler:
          - g++-14
          - clang++
          - cl
        generator:
          - "Ninja Multi-Config"
        include:
          # Add appropriate variables for gcov version required. This will intentionally break
          # if you try to use a compiler that does not have gcov set
          - cpp_compiler: g++-14
            gcov_executable: gcov-14

          - cpp_compiler: clang++
            gcov_executable: "llvm-cov gcov"

          # Set up preferred package generators, for given build configurations
          - os: windows-latest
            cpp_compiler: cl
            generator: "Visual Studio 17 2022"
            build_type: Release
            package_generator: ZIP

          - os: ubuntu-latest
            cpp_compiler: g++-14
            generator: "Unix Makefiles"
            build_type: Release
            package_generator: TBZ2

          - os: ubuntu-latest
            cpp_compiler: clang++
            generator: "Unix Makefiles"
            build_type: Release
            package_generator: TBZ2

        exclude:
          - os: windows-latest
            cpp_compiler: g++-14
          - os: windows-latest
            cpp_compiler: clang++
          - os: ubuntu-latest
            cpp_compiler: cl

    steps:
    - uses: actions/checkout@v4

    - name: Setup Cache
      uses: ./.github/setup_cache
      with:
        compiler: ${{ matrix.cpp_compiler }}
        build_type: ${{ matrix.build_type }}
        generator: ${{ matrix.generator }}

    - name: Install format dependencies
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.cpp_compiler == env.CLANG_COMPILER }}
      run: pip3 install cmake_format==0.6.11 pyyaml

    - name: Check CMake style
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.cpp_compiler == env.CLANG_COMPILER }}
      run: cmake-format --check ./CMakeLists.txt

    - uses: DoozyX/clang-format-lint-action@v0.20
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.cpp_compiler == env.CLANG_COMPILER }}
      with:
        source: '.'
        exclude: './third_party ./external'
        extensions: 'h,cpp,hpp'
        clangFormatVersion: 19
        inplace: True

    - name: Setup Cpp
      uses: aminya/setup-cpp@v1
      with:
        compiler: ${{ matrix.cpp_compiler }}
        vcvarsall: ${{ contains(matrix.os, 'windows' )}}

        cmake: true
        ninja: true
        vcpkg: false
        ccache: true
        clangtidy: ${{ env.CLANG_TIDY_VERSION }}


        cppcheck: true

        gcovr: ${{ contains(matrix.os, 'ubuntu') && matrix.build_type == 'Debug'}}
        opencppcoverage: ${{ contains(matrix.os, 'windows') && matrix.build_type == 'Debug'}}

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: >
        cmake -B ${{ github.workspace }}/build
        -G "${{matrix.generator}}"
        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -D${{ env.PROJECT_NAME }}_ENABLE_CODE_ANALYSIS=ON
        -D${{ env.PROJECT_NAME }}_BUILD_TESTS=ON
        -D${{ env.PROJECT_NAME }}_ENABLE_COVERAGE:BOOL=${{ matrix.build_type == 'Debug' }}
        -D${{ env.PROJECT_NAME }}_BUILD_FUZZ_TESTS:BOOL=${{ matrix.cpp_compiler == env.CLANG_COMPILER && matrix.build_type == 'Debug' }}
        -S ${{ github.workspace }}

    - name: Build
      run: |
        # Build your program with the given configuration. Note that --config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).
        cmake --build ${{ github.workspace }}/build --config ${{ matrix.build_type }} --verbose

    - name: Test
      working-directory: ${{ github.workspace }}/build/test
      # Execute tests defined by the CMake configuration.
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: |
        ctest -C ${{matrix.build_type}} -V

    - name: Fuzz Test
      if: ${{ matrix.cpp_compiler == env.CLANG_COMPILER && matrix.build_type == 'Debug' }}
      working-directory: ${{ github.workspace }}/build/fuzz_test
      # Execute tests defined by the CMake configuration.
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: |
        ctest -C ${{matrix.build_type}} -V

    - name: Unix - Coverage
      if: ${{ matrix.os == 'ubuntu-latest' && matrix.build_type == 'Debug'}}
      working-directory: ${{ github.workspace }}/build
      # Execute tests defined by the CMake configuration.
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: |
        gcovr --root ../ --xml-pretty --xml ${{ github.workspace }}/build/coverage.xml --gcov-executable '${{ matrix.gcov_executable }}'

    - name: Windows - Coverage
      if: ${{ contains(matrix.os, 'windows') && matrix.build_type == 'Debug'}}
      working-directory: ${{ github.workspace }}
      run: |
        OpenCppCoverage.exe --export_type cobertura:${{ github.workspace }}\build\coverage.xml --cover_children --excluded_sources "test\\" --excluded_sources "build\\" --sources "${{ github.workspace }}\src" --sources "${{ github.workspace }}\include" -- ${{ github.workspace }}\build\test\Debug\${{ env.PROJECT_NAME }}Tests.exe

    - name: Get base branch last run id
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RUN_ID=$(gh run list --branch ${{github.base_ref}} --workflow ci.yml --limit 1 --json databaseId -q '.[0].databaseId')
        echo "TARGET_BRANCH_RUN_ID=$RUN_ID" >> $GITHUB_ENV

    - name: Download ${{github.base_ref}} cobertura artifact
      if: ${{ matrix.build_type == 'Debug'}}
      id: download-baseline-cobertura
      # if artifact not found, continue but do not
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ github.token }}
        run-id: ${{env.TARGET_BRANCH_RUN_ID}}
        name: "${{github.base_ref}} ${{matrix.os}} ${{matrix.cpp_compiler}} ${{matrix.generator}}"
        path: ./build/baseline_coveraage

    - name: Check coverage
      if: ${{ matrix.build_type == 'Debug'}}
      uses: ./.github/coverage
      with:
        # Path to the Cobertura XML report.
        path: ./build/coverage.xml
        baseline_path: ${{steps.download-baseline-cobertura.outcome != 'failure' && './build/baseline_coveraage/coverage.xml' || '' }}
        # Minimum total coverage, if you want to the
        # workflow to enforce it as a standard.
        # This has no effect if the `fail` arg is set to `false`.
        threshold: 75
        # Fail the workflow if the minimum code coverage
        # reuqirements are not satisfied.
        fail: true
        # Fail if coverage decreased
        fail_on_decrease: true
        # Publish the rendered output as a PR comment
        publish: true
        # Separate comment for each job in matrix
        comment_header: "## ðŸ§ª Code Coverage Summary ${{matrix.os}} ${{matrix.cpp_compiler}} ${{matrix.generator}}"

    - uses: actions/upload-artifact@v4
      if: ${{ matrix.build_type == 'Debug'}}
      with:
        name: "${{ env.BRANCH_NAME }} ${{matrix.os}} ${{matrix.cpp_compiler}} ${{matrix.generator}}"
        path: ./build/coverage.xml
        overwrite: true

    - name: CPack
      if: matrix.package_generator != ''
      working-directory: ./build
      run: |
        cpack -C ${{matrix.build_type}} -G ${{matrix.package_generator}}

    - name: Publish Tagged Release
      uses: softprops/action-gh-release@v2
      if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.package_generator != '' }}
      with:
        files: |
          build/*-*${{ matrix.build_type }}*-*.*
